<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | Mobilization Church Balilihan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Bungee&display=swap');
        
        :root { --mc-green: #2D4E53; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; min-height: 100vh; }
        
        .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.4); }
        
        .ann-date-box {
            background: linear-gradient(135deg, #2D4E53, #437178);
            color: white;
            min-width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.5rem;
        }

        .nav-logo { width: 40px; height: 40px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .activity-card {
            background: white;
            border-left: 4px solid var(--mc-green);
            transition: all 0.2s ease;
        }
        .activity-card:hover { transform: translateX(5px); background: #fdfdfd; }

        /* Color Swatch Styling */
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
        .color-dot.active { border-color: #cbd5e1; transform: scale(1.2); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="pb-20 text-slate-800">

    <nav class="sticky top-0 z-50 px-4 py-4">
        <div class="max-w-6xl mx-auto glass-effect rounded-[2rem] px-8 py-4 flex justify-between items-center shadow-lg border border-white">
            <div class="flex items-center gap-4">
                <img src="mcb.png" class="nav-logo" alt="Church Logo">
                <div>
                    <h1 class="font-black text-slate-800 text-sm md:text-lg uppercase tracking-tighter leading-none">Admin Portal</h1>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Mobilization Church Balilihan</p>
                </div>
            </div>
            <div id="liveTime" class="text-[10px] font-black text-slate-400 uppercase tracking-widest hidden md:block"></div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 mt-6 space-y-8">
        
        <div class="animate-fade">
            <div class="bg-white p-4 md:p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col md:flex-row gap-6 relative group overflow-hidden">
                <div id="annDateDisplay" class="ann-date-box p-4 md:p-6 shrink-0">
                    <span id="annMonth" class="text-[10px] font-black opacity-60 uppercase tracking-widest">---</span>
                    <span id="annDay" class="text-3xl font-black leading-none">--</span>
                    <div class="h-[1px] w-8 bg-white/30 my-2"></div>
                    <span id="annTime" class="text-[10px] font-bold">--:--</span>
                </div>
                
                <div class="flex-1 flex flex-col justify-center py-2">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-emerald-100 text-emerald-600 text-[9px] font-black px-2 py-1 rounded-full uppercase tracking-tighter">Live Announcement</span>
                        <div class="h-[1px] flex-1 bg-slate-50"></div>
                    </div>
                    <p id="liveNewsPreview" class="text-slate-800 font-bold text-lg md:text-xl leading-relaxed italic">"Loading latest update..."</p>
                    
                    <button onclick="toggleNewsEdit()" class="mt-4 self-start bg-[#2D4E53] text-white px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:opacity-90 transition-all shadow-md">
                        Update Announcement
                    </button>
                </div>

                <div id="newsEditOverlay" class="absolute inset-0 bg-white/95 backdrop-blur-xl translate-y-full transition-transform duration-500 ease-in-out z-30 p-6 md:p-8 flex flex-col rounded-[2.5rem] border-2 border-[#2D4E53]">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-[#2D4E53] font-black uppercase tracking-widest text-xs">Update Public Billboard</h4>
                        <button onclick="toggleNewsEdit()" class="text-slate-400 hover:text-red-500 font-bold text-[10px]">CANCEL [X]</button>
                    </div>
                    <textarea id="annText" class="flex-1 bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-slate-700 outline-none focus:border-emerald-500 transition-all resize-none font-bold" placeholder="Ano ang bagong balita para sa kongregasyon?"></textarea>
                    <button onclick="postAnn()" class="mt-4 bg-[#2D4E53] text-white py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Publish Changes</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 text-center">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Pending Requests</p>
                <h4 id="pCount" class="text-4xl font-black text-amber-500">0</h4>
            </div>
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 text-center">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Approved Programs</p>
                <h4 id="aCount" class="text-4xl font-black text-emerald-500">0</h4>
            </div>
            <div class="bg-[#2D4E53] p-8 rounded-[2.5rem] shadow-sm flex items-center justify-center text-center">
                <div>
                    <p class="text-white/60 text-[9px] font-black uppercase tracking-widest mb-1">Church Authority</p>
                    <p class="text-white font-black text-xs uppercase tracking-[0.2em]">Verified Access</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-8">
            <div class="col-span-12 lg:col-span-4 h-[600px] flex flex-col bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                    <h3 class="font-black text-[10px] uppercase tracking-widest text-slate-500 italic">Incoming Pipeline</h3>
                    <span class="w-2 h-2 rounded-full bg-amber-400 animate-pulse"></span>
                </div>
                <div id="pList" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3 bg-slate-50/30"></div>
            </div>

            <div id="detailView" class="col-span-12 lg:col-span-8 bg-white rounded-[2.5rem] p-6 md:p-10 shadow-sm border border-slate-100 min-h-[600px] flex items-center justify-center text-slate-300 relative border-dashed border-2">
                <div class="text-center max-w-xs">
                    <p class="text-[10px] font-black uppercase tracking-widest">Inspector Preview</p>
                    <p class="text-[9px] mt-2 italic">Pumili ng program sa listahan para sa verification at official seal placement.</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
            <div class="p-8 border-b border-slate-50 flex justify-between items-center">
                <h3 class="text-lg font-black text-slate-800 uppercase tracking-tight leading-none">Approval Registry</h3>
                <span class="text-[9px] font-black bg-slate-100 text-slate-500 px-3 py-1 rounded-full uppercase tracking-tighter">Official Database</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-slate-50/50">
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400">Program Title</th>
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400">Requested By</th>
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="approvedTable" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const sb = supabase.createClient('https://eejovtuputrwneovhfpc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlam92dHVwdXRyd25lb3ZoZnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjY5MzIsImV4cCI6MjA4NjgwMjkzMn0.JJz64gSTT9qSqOkiJvuL1PT_H_I4ZYJbchrmkoljwws');

        let selectedColor = "#059669"; // Default Green

        function setStampColor(color, el) {
            selectedColor = color;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('stampIcon').style.color = color;
            document.getElementById('stampText').style.color = color;
        }

        function toggleNewsEdit() {
            const overlay = document.getElementById('newsEditOverlay');
            overlay.classList.toggle('translate-y-full'); 
            overlay.classList.toggle('translate-y-0');
        }

        async function fetchCurrentNews() {
            const { data } = await sb.from('announcements').select('*').order('created_at', {ascending: false}).limit(1);
            if(data?.[0]) {
                const ann = data[0];
                const dateObj = new Date(ann.created_at);
                document.getElementById('liveNewsPreview').innerText = `"${ann.content}"`;
                document.getElementById('annMonth').innerText = dateObj.toLocaleString('default', { month: 'short' }).toUpperCase();
                document.getElementById('annDay').innerText = dateObj.getDate();
                document.getElementById('annTime').innerText = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        }

        async function postAnn() {
            const content = document.getElementById('annText').value;
            if(!content) return;
            const { error } = await sb.from('announcements').insert({ content });
            if(!error) { 
                alert("Announcement Updated!"); 
                document.getElementById('annText').value = ""; 
                toggleNewsEdit(); 
                fetchCurrentNews(); 
            }
        }

        async function loadData() {
            const { data: pendings } = await sb.from('programs').select('*').eq('status', 'pending');
            document.getElementById('pCount').innerText = pendings?.length || 0;
            document.getElementById('pList').innerHTML = pendings?.map(i => `
                <div onclick="showProg('${i.id}')" class="p-5 bg-white rounded-3xl border border-transparent hover:border-[#2D4E53] cursor-pointer transition-all animate-fade shadow-sm group">
                    <div class="flex justify-between items-start">
                        <p class="font-black text-xs text-slate-800 uppercase tracking-tight group-hover:text-[#2D4E53] transition-colors">${i.title}</p>
                        <span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
                    </div>
                    <p class="text-[9px] text-slate-400 font-bold uppercase mt-2 tracking-widest">${i.user_id}</p>
                </div>
            `).join('') || '<p class="text-center p-10 text-[10px] uppercase font-bold text-slate-300 italic">No pending submissions</p>';

            const { data: approved } = await sb.from('programs').select('*').eq('status', 'approved').order('approved_at', {ascending: false}).limit(10);
            document.getElementById('aCount').innerText = approved?.length || 0;
            document.getElementById('approvedTable').innerHTML = approved?.map(i => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-6 font-black text-xs uppercase text-slate-700">${i.title}</td>
                    <td class="p-6 text-[10px] font-bold text-slate-400 uppercase tracking-widest">${i.user_id}</td>
                    <td class="p-6 text-right"><button onclick="deleteProg('${i.id}')" class="text-red-300 hover:text-red-500 font-black text-[9px] uppercase tracking-widest transition-colors">Archive</button></td>
                </tr>`).join('') || '';
        }

        async function showProg(id) {
            const { data: i } = await sb.from('programs').select('*').eq('id', id).single();
            const detailView = document.getElementById('detailView');
            selectedColor = "#059669"; // Reset to Green default each open
            
            detailView.className = "col-span-12 lg:col-span-8 bg-white rounded-[2.5rem] p-6 md:p-10 shadow-xl border-2 border-[#2D4E53] animate-fade overflow-hidden block";
            
            detailView.innerHTML = `
                <div class="h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-8 pb-6 border-b border-slate-100">
                        <div>
                            <span class="bg-[#2D4E53] text-white text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-[0.2em] mb-3 inline-block">Verify Request</span>
                            <h2 class="text-3xl font-black text-slate-800 uppercase tracking-tighter leading-tight">${i.title}</h2>
                            <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mt-1">Requested by: ${i.user_id}</p>
                        </div>
                    </div>
                    
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-8 overflow-hidden">
                        <div class="space-y-3 overflow-y-auto custom-scroll pr-2 h-[350px]">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 sticky top-0 bg-white">Program Sequence</p>
                            ${i.content.map(c => `
                                <div class="activity-card p-4 rounded-2xl shadow-sm border border-slate-50">
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Activity</p>
                                    <p class="font-bold text-slate-800 text-sm uppercase leading-tight">${c.act}</p>
                                    <p class="text-[10px] font-bold text-[#2D4E53] uppercase italic mt-1">In-Charge: ${c.who}</p>
                                </div>
                            `).join('')}
                        </div>

                        <div class="flex flex-col justify-between">
                            <div class="bg-slate-50 rounded-3xl p-6 border border-slate-100">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Official Stamp Ink Choice</p>
                                
                                <div class="flex gap-4 mb-6">
                                    <div onclick="setStampColor('#ef4444', this)" class="color-dot bg-red-500" title="Red"></div>
                                    <div onclick="setStampColor('#2563eb', this)" class="color-dot bg-blue-600" title="Blue"></div>
                                    <div onclick="setStampColor('#0f172a', this)" class="color-dot bg-slate-900" title="Black"></div>
                                    <div onclick="setStampColor('#059669', this)" class="color-dot bg-emerald-600 active" title="Green"></div>
                                </div>

                                <div class="bg-white p-5 rounded-2xl border-2 border-dashed border-slate-200">
                                    <div class="flex items-center gap-4">
                                        <div id="stampIcon" class="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center transition-colors" style="color: #059669;">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        </div>
                                        <div id="stampText" class="min-w-0 transition-colors" style="color: #059669;">
                                            <p class="text-[10px] font-black uppercase tracking-tighter">Approved Stamp</p>
                                            <p class="text-[9px] font-black uppercase leading-none mt-1">Official MCB Seal</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4 pt-4">
                                <button onclick="approveProg('${i.id}')" class="w-full bg-[#2D4E53] hover:opacity-90 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-[0.2em] shadow-lg transition-all active:scale-95">
                                    Verify & Stamp
                                </button>
                                <button onclick="updateStatus('${i.id}', 'rejected')" class="w-full bg-white border-2 border-slate-100 text-slate-400 hover:text-red-500 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest transition-all">
                                    Reject
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        async function approveProg(id) {
            const { error } = await sb.from('programs').update({ 
                status: 'approved', 
                approved_at: new Date().toISOString(),
                stamp_color: selectedColor // Isasave ang napiling kulay
            }).eq('id', id);
            
            if(!error) {
                alert("Program Officially Stamped and Released!");
                location.reload();
            } else {
                alert("Error saving: Make sure 'stamp_color' column exists in Supabase.");
            }
        }

        async function updateStatus(id, status) {
            if(status === 'rejected' && !confirm("Reject this program?")) return;
            await sb.from('programs').update({ status }).eq('id', id);
            location.reload();
        }

        async function deleteProg(id) {
            if(confirm("Archive this record?")) { 
                await sb.from('programs').delete().eq('id', id); 
                location.reload(); 
            }
        }

        setInterval(() => { 
            const now = new Date();
            document.getElementById('liveTime').innerText = now.toLocaleString(); 
        }, 1000);

        fetchCurrentNews();
        loadData();
    </script>
</body>
</html>
