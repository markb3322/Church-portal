<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | MC Balilihan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f4f4; color: #1e293b; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .bg-mc-green { background-color: #2D4E53; }
    </style>
</head>
<body class="min-h-screen">
    <nav class="bg-mc-green text-white p-4 sticky top-0 z-50 shadow-xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-emerald-500 p-2.5 rounded-2xl shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
                <div>
                    <h2 class="font-extrabold text-base tracking-tight uppercase">MC Balilihan</h2>
                    <p class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest leading-none">Management System</p>
                </div>
            </div>
            <span class="text-[10px] font-black bg-white/10 px-4 py-2 rounded-full uppercase tracking-tighter border border-white/20">Admin Panel</span>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
        
        <div class="grid grid-cols-12 gap-8">
            <div class="col-span-12 lg:col-span-4 space-y-8">
                <div class="bg-white p-8 rounded-[2rem] card-shadow border-t-4 border-emerald-500">
                    <h3 class="font-bold text-[11px] text-emerald-600 mb-5 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> Publish News
                    </h3>
                    <textarea id="annText" class="w-full bg-slate-50 border-none p-5 text-sm rounded-[1.5rem] h-32 focus:ring-2 focus:ring-emerald-500 outline-none transition resize-none placeholder-slate-400" placeholder="Type news here..."></textarea>
                    <button onclick="postAnn()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl mt-4 text-[11px] font-black uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-lg">Post to Portal</button>
                </div>

                <div class="bg-white rounded-[2rem] card-shadow overflow-hidden border border-slate-100">
                    <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                        <h3 class="font-bold text-slate-800 text-[11px] uppercase tracking-widest">Pending Review</h3>
                        <span id="pCount" class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-[10px] font-black">0</span>
                    </div>
                    <div id="pList" class="divide-y divide-slate-50 max-h-[400px] overflow-y-auto custom-scroll">
                        <div class="p-10 text-center text-slate-300 text-[10px] font-bold uppercase italic">Loading...</div>
                    </div>
                </div>
            </div>

            <div id="detailView" class="col-span-12 lg:col-span-8 bg-white rounded-[2.5rem] card-shadow border border-slate-100 p-8 flex items-center justify-center text-slate-300 relative min-h-[500px]">
                <div class="text-center">
                    <p class="font-bold italic text-sm text-emerald-600/40 uppercase tracking-widest">Select a program to review</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] card-shadow border border-slate-100 overflow-hidden">
            <div class="p-8 bg-mc-green text-white flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h3 class="font-black text-xl tracking-tight uppercase">Approval Master List</h3>
                    <p id="aCount" class="text-[10px] text-emerald-300 font-bold uppercase tracking-[0.2em] mt-1 italic">0 Programs Approved</p>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-slate-50">
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">User Name</th>
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest text-center">Program Title</th>
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest text-center">Stamp Ink</th>
                            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="approvedTable" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const sb = supabase.createClient('https://eejovtuputrwneovhfpc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlam92dHVwdXRyd25lb3ZoZnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjY5MzIsImV4cCI6MjA4NjgwMjkzMn0.JJz64gSTT9qSqOkiJvuL1PT_H_I4ZYJbchrmkoljwws');

        async function postAnn() {
            const content = document.getElementById('annText').value;
            if(!content) return alert("Please type something.");
            const { error } = await sb.from('announcements').insert({ content });
            if(!error) { alert("Announcement Posted!"); document.getElementById('annText').value = ""; }
        }

        async function loadData() {
            // LOAD PENDINGS
            const { data: pendings } = await sb.from('programs').select('*').eq('status', 'pending');
            document.getElementById('pCount').innerText = pendings ? pendings.length : 0;
            document.getElementById('pList').innerHTML = (pendings && pendings.length) ? pendings.map(i => `
                <div onclick="showProg('${i.id}')" class="p-5 cursor-pointer hover:bg-emerald-50 transition border-l-4 border-transparent hover:border-emerald-500 group">
                    <p class="font-bold text-xs text-slate-800 group-hover:text-emerald-700 uppercase tracking-tight">${i.title}</p>
                    <p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Submitter: ${i.user_id}</p>
                </div>
            `).join('') : '<div class="p-10 text-center text-slate-300 text-[10px] font-bold uppercase italic">No pending requests</div>';

            // LOAD APPROVED
            const { data: approved } = await sb.from('programs').select('*').eq('status', 'approved').order('approved_at', {ascending: false});
            document.getElementById('aCount').innerText = `${approved ? approved.length : 0} PROGRAMS APPROVED`;
            document.getElementById('approvedTable').innerHTML = (approved && approved.length) ? approved.map(i => `
                <tr class="hover:bg-slate-50/50 transition-colors">
                    <td class="p-6 font-bold text-slate-700 text-sm uppercase">${i.user_id}</td>
                    <td class="p-6 text-center font-black text-xs text-slate-500 uppercase">${i.title}</td>
                    <td class="p-6 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${i.stamp_color || '#1e40af'}"></div>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Ink Set</span>
                        </div>
                    </td>
                    <td class="p-6 text-right">
                        <button onclick="deleteProg('${i.id}')" class="text-red-300 hover:text-red-600 transition-all font-black text-[10px] uppercase tracking-widest px-4 py-2 hover:bg-red-50 rounded-lg">Delete Record</button>
                    </td>
                </tr>`).join('') : '<tr><td colspan="4" class="p-10 text-center text-slate-300 font-bold uppercase text-[10px]">Database Empty</td></tr>';
        }

        async function showProg(id) {
            const { data: i } = await sb.from('programs').select('*').eq('id', id).single();
            const detailView = document.getElementById('detailView');
            detailView.classList.remove('flex', 'items-center', 'justify-center', 'text-slate-300');
            
            detailView.innerHTML = `
                <div class="w-full animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="mb-8 border-b border-emerald-50 pb-6">
                        <h2 class="text-3xl font-black text-mc-green uppercase tracking-tighter">${i.title}</h2>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-2">Submitted By: <span class="text-emerald-600">${i.user_id}</span></p>
                    </div>
                    
                    <div class="bg-slate-50 rounded-[2rem] p-6 mb-8 border border-slate-100 max-h-64 overflow-y-auto custom-scroll">
                        <table class="w-full text-sm">
                            <tbody class="divide-y divide-slate-200">
                                ${i.content.map(c => `<tr><td class="py-3 font-bold text-slate-800 uppercase text-[10px]">${c.act}</td><td class="py-3 text-right text-slate-500 font-medium">${c.who}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="bg-emerald-50 p-6 rounded-2xl mb-8 border border-emerald-100">
                        <p class="text-[10px] font-black uppercase text-emerald-700 mb-4 tracking-widest">Choose Digital Stamp Color</p>
                        <div class="flex flex-wrap gap-6">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="stampColor" value="#059669" class="accent-emerald-600"><span class="text-[10px] font-black text-emerald-700 uppercase">Emerald</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="stampColor" value="#1e40af" checked class="accent-blue-700"><span class="text-[10px] font-black text-blue-700 uppercase">Blue</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="stampColor" value="#000000" class="accent-black"><span class="text-[10px] font-black text-slate-900 uppercase">Black</span></label>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="approveWithSelectedColor('${i.id}')" class="flex-1 bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-lg hover:bg-emerald-700 transition-all">Approve Program</button>
                        <button onclick="updateStatus('${i.id}', 'rejected')" class="bg-slate-100 text-slate-400 py-4 px-8 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:text-red-500">Reject</button>
                    </div>
                </div>
            `;
        }

        async function approveWithSelectedColor(id) {
            const selectedColor = document.querySelector('input[name="stampColor"]:checked').value;
            const { error } = await sb.from('programs').update({ 
                status: 'approved',
                approved_at: new Date().toISOString(),
                stamp_color: selectedColor 
            }).eq('id', id);
            
            if(!error) { alert("Approved Successfully!"); location.reload(); }
            else { alert("Error: " + error.message); console.error(error); }
        }

        async function updateStatus(id, status) {
            const { error } = await sb.from('programs').update({ status }).eq('id', id);
            if(!error) { alert(`Marked as ${status}`); location.reload(); }
        }

        async function deleteProg(id) {
            if(confirm("Are you sure you want to delete this approved program?")) {
                const { error } = await sb.from('programs').delete().eq('id', id);
                if(!error) { alert("Deleted!"); location.reload(); }
            }
        }

        loadData();
    </script>
</body>
</html>
