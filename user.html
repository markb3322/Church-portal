<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard | MC Balilihan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; scroll-behavior: smooth; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .announcement-glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen">
    
    <nav class="bg-[#2D4E53] text-white p-5 px-6 md:px-10 flex justify-between items-center shadow-lg sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="bg-emerald-500 p-2 rounded-xl shadow-lg shadow-emerald-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10l4 4v10a2 2 0 01-2 2z" />
                </svg>
            </div>
            <h1 class="font-black tracking-widest text-xs md:text-sm uppercase">MC Balilihan Staff Portal</h1>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4">
            <div class="bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 sticky top-28 overflow-hidden">
                <div class="bg-gradient-to-br from-[#2D4E53] to-[#1a3135] p-6 text-white">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-black text-[10px] uppercase tracking-[0.2em] opacity-80">Official Update</h3>
                        <span class="flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-emerald-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                        </span>
                    </div>
                    <h2 class="text-xl font-extrabold tracking-tight">Announcement</h2>
                </div>
                
                <div class="p-8 relative">
                    <div class="absolute top-0 right-0 -mt-4 mr-6 bg-emerald-500 text-white p-3 rounded-2xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                    </div>

                    <div id="newsFeed" class="space-y-4">
                        <div class="bg-slate-50/80 rounded-3xl p-6 border border-dashed border-slate-200">
                            <p id="newsContent" class="text-sm font-bold text-slate-700 leading-relaxed italic">
                                Checking for latest updates from the administration...
                            </p>
                        </div>
                        
                        <div class="flex items-center justify-between px-2">
                            <div class="flex flex-col">
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Posted on</span>
                                <span id="newsDate" class="text-xs font-bold text-[#2D4E53]">--/--/--</span>
                            </div>
                            <button onclick="loadNews()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-8">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                <h3 class="font-black text-slate-800 uppercase text-[11px] tracking-[0.2em] mb-4">Verification & Records</h3>
                <input id="verifyName" type="text" placeholder="Enter Full Name to search records..." 
                    class="w-full bg-slate-50 border-2 border-slate-100 p-4 rounded-2xl text-sm font-bold focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 outline-none transition-all mb-8">
                
                <div class="space-y-10">
                    <div>
                        <h4 class="text-[10px] font-black uppercase text-emerald-700 tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span> Approved Programs
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <tbody id="approvedList"></tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-[10px] font-black uppercase text-red-700 tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span> Rejected / Needs Revision
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <tbody id="rejectedList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="formSection" class="bg-white p-6 md:p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                <h2 id="formTitle" class="text-2xl font-black text-slate-800 tracking-tight">Create New Program</h2>
                <form id="progForm" class="space-y-6 mt-8">
                    <div class="space-y-4">
                        <input id="fullName" type="text" placeholder="Full Name (Submitter)" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-emerald-500 outline-none" required>
                        <div class="grid grid-cols-2 gap-4">
                            <input id="title" type="text" placeholder="Service Title" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-emerald-500 outline-none" required>
                            <input id="date" type="date" class="w-full bg-slate-50 border-none p-4 rounded-2xl text-sm font-bold focus:ring-2 focus:ring-emerald-500 outline-none" required>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-6 rounded-[2rem]">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-black uppercase text-slate-400">Segments</span>
                            <button type="button" onclick="addRow()" class="bg-slate-900 text-white text-[9px] px-4 py-2 rounded-xl font-black transition-transform active:scale-95">+ ADD</button>
                        </div>
                        <div id="rowContainer" class="space-y-3"></div>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-[#2D4E53] text-white py-5 rounded-[2rem] font-black text-xs uppercase tracking-[0.2em] shadow-xl hover:bg-[#1a3135] hover:-translate-y-1 transition-all active:scale-[0.98]">SUBMIT PROGRAM</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const sb = supabase.createClient('https://eejovtuputrwneovhfpc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlam92dHVwdXRyd25lb3ZoZnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjY5MzIsImV4cCI6MjA4NjgwMjkzMn0.JJz64gSTT9qSqOkiJvuL1PT_H_I4ZYJbchrmkoljwws');

        let allLoadedProgs = [];

        async function loadNews() {
            const { data } = await sb.from('announcements').select('*').order('created_at', {ascending: false}).limit(1).single();
            if (data) {
                document.getElementById('newsContent').innerText = data.content;
                document.getElementById('newsDate').innerText = new Date(data.created_at).toLocaleDateString();
            }
        }

        function addRow(actVal = '', whoVal = '') {
            const d = document.createElement('div'); 
            d.className = "flex gap-3 act-row animate-in fade-in slide-in-from-top-2 duration-300";
            d.innerHTML = `
                <input type="text" placeholder="Activity" value="${actVal}" class="act bg-white border border-slate-200 p-3 rounded-xl w-1/2 text-xs font-bold outline-none focus:ring-2 focus:ring-emerald-500/20" required> 
                <input type="text" placeholder="In-charge" value="${whoVal}" class="who bg-white border border-slate-200 p-3 rounded-xl w-1/2 text-xs font-bold outline-none focus:ring-2 focus:ring-emerald-500/20" required>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 font-black px-1 transition-colors">Ã—</button>
            `;
            document.getElementById('rowContainer').appendChild(d);
        }

        async function loadHistory(username) {
            if(!username || username.length < 3) return;
            const { data: progs } = await sb.from('programs').select('*').eq('user_id', username).order('created_at', {ascending:false});
            allLoadedProgs = progs || [];
            renderTables(username);
        }

        function renderTables(username) {
            const appList = document.getElementById('approvedList');
            const rejList = document.getElementById('rejectedList');
            appList.innerHTML = ""; rejList.innerHTML = "";

            allLoadedProgs.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-50 hover:bg-slate-50/50 transition-colors";
                const tdTitle = document.createElement('td');
                tdTitle.className = "py-4 text-xs font-bold text-slate-700 uppercase";
                tdTitle.textContent = item.title;
                const tdActions = document.createElement('td');
                tdActions.className = "py-4 text-right space-x-2";

                if(item.status === 'approved') {
                    tdActions.append(
                        createBtn('DOC', 'bg-slate-900 text-white', () => exportToWord(item)),
                        createBtn('DELETE', 'bg-red-50 text-red-500', () => deleteProgram(item.id, username))
                    );
                } else if(item.status === 'rejected') {
                    tdActions.append(
                        createBtn('EDIT', 'bg-red-600 text-white', () => editRejected(item)),
                        createBtn('DELETE', 'bg-slate-100 text-slate-400', () => deleteProgram(item.id, username))
                    );
                }
                tr.append(tdTitle, tdActions);
                (item.status === 'approved' ? appList : rejList).appendChild(tr);
            });

            if(!appList.children.length) appList.innerHTML = '<tr><td class="py-4 text-center text-[9px] text-slate-300">No records</td></tr>';
            if(!rejList.children.length) rejList.innerHTML = '<tr><td class="py-4 text-center text-[9px] text-slate-300">No records</td></tr>';
        }

        function createBtn(text, classes, onClick) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = `${classes} text-[8px] font-black px-3 py-2 rounded-lg transition-all active:scale-95 hover:opacity-90 shadow-sm`;
            btn.onclick = (e) => { e.preventDefault(); onClick(); };
            return btn;
        }

        async function deleteProgram(id, user) {
            if(confirm("Delete this record permanently?")) {
                const { error } = await sb.from('programs').delete().eq('id', id);
                if(!error) loadHistory(user);
            }
        }

        function editRejected(data) {
            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('formTitle').innerText = "Update Program";
            document.getElementById('fullName').value = data.user_id;
            document.getElementById('title').value = data.title;
            document.getElementById('date').value = data.program_date;
            document.getElementById('rowContainer').innerHTML = '';
            if(data.content) data.content.forEach(row => addRow(row.act, row.who));
            const sBtn = document.getElementById('submitBtn');
            sBtn.innerText = "RESUBMIT FOR APPROVAL";
            sBtn.classList.replace('bg-[#2D4E53]', 'bg-red-600');
        }

        function exportToWord(i) {
            const rows = i.content.map(c => `<tr><td style="border:1px solid black;padding:8px">${c.act.toUpperCase()}</td><td style="border:1px solid black;padding:8px;text-align:right">${c.who}</td></tr>`).join('');
            const html = `<html><body style="font-family:Arial;padding:40px"><h2 align="center">MC BALILIHAN SERVICE PROGRAM</h2><p><b>TITLE:</b> ${i.title.toUpperCase()}</p><p><b>DATE:</b> ${i.program_date}</p><table width="100%" style="border-collapse:collapse">${rows}</table></body></html>`;
            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${i.title}.doc`;
            link.click();
        }

        document.getElementById('verifyName').addEventListener('input', (e) => loadHistory(e.target.value));

        document.getElementById('progForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "SUBMITTING...";

            const content = Array.from(document.querySelectorAll('.act-row')).map(d => ({
                act: d.querySelector('.act').value, 
                who: d.querySelector('.who').value
            }));

            const { error } = await sb.from('programs').insert({ 
                user_id: document.getElementById('fullName').value, 
                title: document.getElementById('title').value, 
                program_date: document.getElementById('date').value, 
                content: content, 
                status: 'pending'
            });

            if (!error) { alert("Submitted successfully!"); location.reload(); } 
            else { alert(error.message); btn.disabled = false; btn.innerText = "SUBMIT PROGRAM"; }
        }

        addRow();
        loadNews();
    </script>
</body>
</html>
