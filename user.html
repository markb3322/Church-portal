<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Portal | MC Balilihan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Bungee&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .official-stamp {
            border: 6px double currentColor;
            border-radius: 15px;
            padding: 15px;
            display: inline-block;
            transform: rotate(-5deg);
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Bungee', cursive;
        }
        #exportTemplate { width: 800px; position: absolute; left: -9999px; background: white; padding: 60px; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div id="exportTemplate">
        <div style="text-align: center; border-bottom: 4px solid #1e293b; padding-bottom: 20px; margin-bottom: 30px;">
            <h1 style="font-size: 32px; font-weight: 900; color: #2D4E53; margin: 0;">MOBILIZATION CHURCH BALILIHAN</h1>
            <p style="letter-spacing: 5px; font-weight: 800; color: #94a3b8; font-size: 14px; margin-top: 5px;">OFFICIAL SERVICE PROGRAM</p>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 40px;">
            <div><p style="font-size: 12px; font-weight: 800; color: #64748b;">PROGRAM TITLE</p><h2 id="expTitle" style="font-size: 28px; font-weight: 900; color: #1e293b; margin: 0;"></h2></div>
            <div style="text-align: right;"><p style="font-size: 12px; font-weight: 800; color: #64748b;">DATE</p><h2 id="expDate" style="font-size: 24px; font-weight: 700; color: #334155; margin: 0;"></h2></div>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 50px;">
            <tbody id="expRows" style="font-size: 18px; font-weight: 600;"></tbody>
        </table>
        <div style="display: flex; justify-content: flex-end;">
            <div id="stampBox" class="official-stamp">
                <div style="font-size: 12px; border-bottom: 2px solid currentColor; margin-bottom: 5px;">MC BALILIHAN</div>
                <div style="font-size: 45px; line-height: 1;">APPROVED</div>
                <div id="stampMeta" style="font-size: 10px; margin-top: 5px; display: flex; justify-content: space-between; font-family: sans-serif;"></div>
            </div>
        </div>
    </div>

    <nav class="bg-[#2D4E53] text-white p-5 shadow-lg flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="bg-emerald-500 p-2 rounded-xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10l4 4v10a2 2 0 01-2 2z" /></svg>
            </div>
            <h1 class="font-black tracking-tighter text-xl uppercase">MC Portal</h1>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-8 space-y-8">
            
            <div class="bg-white rounded-[2rem] shadow-xl border-l-8 border-emerald-500 overflow-hidden">
                <div class="p-6 bg-emerald-50/50 border-b border-emerald-100 flex items-center gap-3">
                    <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span></span>
                    <h3 class="font-black text-emerald-900 text-xs uppercase tracking-widest">Latest Announcement</h3>
                </div>
                <div id="annContainer" class="p-8">
                    <p class="text-slate-400 font-bold italic animate-pulse">Checking for updates...</p>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-slate-100">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <h2 class="text-2xl font-black text-slate-800 tracking-tight">Program History</h2>
                    <input id="searchName" type="text" placeholder="Type your name to find records..." class="p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl outline-none focus:border-emerald-500 font-bold transition-all w-full md:w-72 text-sm">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <tbody id="historyList" class="divide-y divide-slate-50">
                            <tr><td class="p-10 text-center text-slate-300 font-bold uppercase text-[10px] tracking-widest">Search your name above</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="lg:col-span-4">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 sticky top-28">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    </div>
                    <h3 class="text-xl font-black text-slate-800">New Program</h3>
                </div>
                <form id="progForm" class="space-y-4">
                    <input id="userName" type="text" placeholder="Your Full Name" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border-2 border-transparent focus:border-emerald-500" required>
                    <input id="progTitle" type="text" placeholder="Service Title" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border-2 border-transparent focus:border-emerald-500" required>
                    <input id="progDate" type="date" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border-2 border-transparent focus:border-emerald-500" required>
                    <div id="rowContainer" class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scroll"></div>
                    <button type="button" onclick="addRow()" class="w-full py-2 border-2 border-dashed border-emerald-200 rounded-xl text-emerald-600 font-bold text-[10px] hover:bg-emerald-50 transition-all uppercase tracking-widest">+ Add Row</button>
                    <button type="submit" id="submitBtn" class="w-full bg-[#2D4E53] text-white py-4 rounded-2xl font-black shadow-lg hover:bg-emerald-900 transition-all uppercase tracking-widest text-[11px]">Submit Program</button>
                </form>
            </div>
        </div>
    </main>

    <script>
        const sb = supabase.createClient('https://eejovtuputrwneovhfpc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlam92dHVwdXRyd25lb3ZoZnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjY5MzIsImV4cCI6MjA4NjgwMjkzMn0.JJz64gSTT9qSqOkiJvuL1PT_H_I4ZYJbchrmkoljwws');

        // LOAD ANNOUNCEMENTS
        async function loadAnn() {
            const { data, error } = await sb.from('announcements').select('*').order('created_at', {ascending: false}).limit(1);
            if(data && data[0]) {
                document.getElementById('annContainer').innerHTML = `
                    <p class="text-slate-800 font-bold text-lg leading-relaxed">${data[0].content}</p>
                    <p class="text-[10px] text-slate-400 font-black uppercase mt-4 tracking-widest">Posted on: ${new Date(data[0].created_at).toLocaleDateString()}</p>
                `;
            } else {
                document.getElementById('annContainer').innerHTML = `<p class="text-slate-400 font-bold italic">No active announcements.</p>`;
            }
        }

        function addRow(act='', who='') {
            const div = document.createElement('div');
            div.className = "flex gap-2 act-row";
            div.innerHTML = `
                <input type="text" placeholder="Activity" class="act flex-1 p-3 bg-slate-50 rounded-lg text-xs font-bold border border-transparent focus:border-emerald-200 outline-none" required>
                <input type="text" placeholder="Who" class="who w-1/3 p-3 bg-slate-50 rounded-lg text-xs font-bold border border-transparent focus:border-emerald-200 outline-none" required>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-300 hover:text-red-500 font-bold px-1">Ã—</button>
            `;
            document.getElementById('rowContainer').appendChild(div);
        }

        async function loadHistory(name) {
            if(name.length < 3) return;
            const { data } = await sb.from('programs').select('*').eq('user_id', name).order('created_at', {ascending: false});
            const list = document.getElementById('historyList');
            list.innerHTML = data.length ? data.map(i => `
                <tr class="group hover:bg-slate-50 transition-all">
                    <td class="p-6">
                        <div class="flex items-center gap-3">
                            <span class="w-2 h-2 rounded-full ${i.status === 'approved' ? 'bg-emerald-500' : 'bg-amber-400 animate-pulse'}"></span>
                            <div>
                                <h4 class="font-black text-slate-800 uppercase text-sm">${i.title}</h4>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${i.program_date} | STATUS: ${i.status}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-6 text-right">
                        ${i.status === 'approved' ? `
                            <button onclick='exportImage(${JSON.stringify(i)})' class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl text-[10px] font-black shadow-lg hover:bg-emerald-700 transition-all uppercase">Get Image</button>
                        ` : '<span class="text-[10px] font-black text-slate-300 uppercase tracking-widest italic">Awaiting Review</span>'}
                    </td>
                </tr>
            `).join('') : '<tr><td class="p-10 text-center text-slate-300 font-bold uppercase">No records found.</td></tr>';
        }

        async function exportImage(item) {
            const temp = document.getElementById('exportTemplate');
            const stampColor = item.stamp_color || "#1e40af";
            const appDate = item.approved_at ? new Date(item.approved_at) : new Date();

            document.getElementById('expTitle').innerText = item.title.toUpperCase();
            document.getElementById('expDate').innerText = item.program_date;
            document.getElementById('expRows').innerHTML = item.content.map(c => `
                <tr style="border-bottom: 1px solid #e2e8f0;"><td style="padding: 15px;">${c.act.toUpperCase()}</td><td style="padding: 15px; text-align: right; color: #64748b;">${c.who}</td></tr>
            `).join('');

            const stamp = document.getElementById('stampBox');
            stamp.style.color = stampColor;
            stamp.style.borderColor = stampColor;
            document.getElementById('stampMeta').innerHTML = `<span>VERIFIED: ${appDate.toLocaleDateString()}</span><span>${appDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>`;

            html2canvas(temp, { scale: 3 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `APPROVED_${item.title}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        document.getElementById('searchName').addEventListener('input', (e) => loadHistory(e.target.value));
        
        document.getElementById('progForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "SENDING..."; btn.disabled = true;
            
            const content = Array.from(document.querySelectorAll('.act-row')).map(r => ({
                act: r.querySelector('.act').value, who: r.querySelector('.who').value
            }));
            
            const { error } = await sb.from('programs').insert({
                user_id: document.getElementById('userName').value,
                title: document.getElementById('progTitle').value,
                program_date: document.getElementById('progDate').value,
                content: content,
                status: 'pending'
            });

            if(!error) { alert("Sent successfully!"); location.reload(); }
            else { alert("Error: " + error.message); btn.innerText = "SUBMIT PROGRAM"; btn.disabled = false; }
        }

        addRow();
        loadAnn(); // Fetch announcement on load
    </script>
</body>
</html>
