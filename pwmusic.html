<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MCB Music Portal | Official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        :root { --mcb-blue: #2c3e50; --mcb-gold: #f1c40f; --mcb-red: #e74c3c; --mcb-green: #27ae60; --mc-primary: #2D4E53; }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; padding-bottom: 140px; }

        .emoji-overlay { position: fixed; inset: 0; z-index: -1; overflow: hidden; display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; padding: 20px; opacity: 0.08; pointer-events: none; user-select: none; }
        .emoji-item { font-size: 4rem; display: flex; align-items: center; justify-content: center; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .day { background: rgba(255, 255, 255, 0.8); border: 1px solid #e2e8f0; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 800; transition: 0.3s; font-size: 14px; }
        .day:hover { background: white; border-color: var(--mcb-gold); transform: translateY(-2px); }
        .day.today { background: var(--mc-primary); color: white; border-color: var(--mc-primary); }
        .day.empty { background: transparent; border: none; cursor: default; }
        .day-header { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; text-align: center; }

        #form-modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 1000; backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 2rem; position: relative; max-height: 90vh; overflow-y: auto; }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .input-style { width: 100%; padding: 12px; background: #f1f5f9; border: 2px solid transparent; border-radius: 12px; font-weight: 700; outline: none; margin-bottom: 10px; }
        .btn-nav { padding: 10px 20px; border-radius: 10px; font-weight: 800; text-transform: uppercase; font-size: 12px; }

        .stepper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .step-circle { width: 25px; height: 25px; border-radius: 50%; background: #f1f5f9; font-size: 10px; font-weight: 800; display: flex; align-items: center; justify-content: center; color: #cbd5e1; }
        .step-circle.active { background: var(--mc-primary); color: white; }
        .step-line { flex: 1; height: 2px; background: #f1f5f9; margin: 0 10px; }

        .footer-container { position: fixed; bottom: 0; left: 0; right: 0; z-index: 500; background: white; border-top: 1px solid #f1f5f9; }
        .fixed-footer { height: 65px; display: flex; align-items: center; border-bottom: 1px solid #f8fafc; }
        .bottom-menu { height: 65px; display: flex; justify-content: space-around; align-items: center; }
        .menu-item { text-align: center; color: #94a3b8; flex: 1; transition: 0.3s; text-decoration: none; }
        .menu-item.music-active { color: #27ae60; }
        .menu-item i { font-size: 1.1rem; display: block; }
        .menu-item span { font-size: 9px; font-weight: 800; text-transform: uppercase; }

        /* Hidden Slip Template */
        #slip-template { position: absolute; left: -9999px; top: 0; width: 400px; background: white; padding: 30px; border: 10px solid #2D4E53; }
    </style>
</head>
<body>

    <section class="emoji-overlay">
        <div class="emoji-item">ðŸŽ¸</div><div class="emoji-item">ðŸŽ¹</div><div class="emoji-item">ðŸŽ¶</div><div class="emoji-item">âœ¨</div><div class="emoji-item">ðŸŽ¤</div>
    </section>

    <div id="slip-template">
        <div class="text-center border-b-2 border-slate-200 pb-4 mb-4">
            <img src="mcb.png" crossorigin="anonymous" class="w-12 h-12 mx-auto mb-2" onerror="this.src='https://via.placeholder.com/48'">
            <h2 class="text-lg font-black uppercase text-slate-800">Music Lineup Slip</h2>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">MCB Balilihan Official</p>
        </div>
        <div id="slip-content" class="space-y-3"></div>
        <div class="mt-6 pt-4 border-t-2 border-dashed border-slate-200 text-center">
            <p class="text-[9px] font-black text-emerald-600 uppercase">Status: Officially Approved</p>
            <p class="text-[8px] text-slate-400 mt-2">Generated via MCB Music Portal 2026</p>
        </div>
    </div>

    <nav class="bg-white/90 backdrop-blur px-6 py-4 flex justify-between items-center sticky top-0 z-[500] border-b">
        <div class="flex items-center gap-4">
            <img src="mcb.png" class="w-10 h-10" onerror="this.src='https://via.placeholder.com/40'">
            <div>
                <h1 class="text-sm font-black text-slate-900 uppercase">Music Portal</h1>
                <p id="greeting" class="text-[9px] font-bold text-emerald-500 uppercase tracking-widest">Maayong Adlaw!</p>
            </div>
        </div>
        <div class="text-right">
            <p id="liveDate" class="text-[10px] font-bold text-slate-400 uppercase">---</p>
            <p id="liveClock" class="text-sm font-black text-[#2D4E53]">00:00:00</p>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <div class="mb-8">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h2 class="text-xl font-black text-slate-800 uppercase leading-none">Music Scheduler</h2>
                    <p id="month-title" class="text-[12px] font-bold text-emerald-600 uppercase mt-1">Month Year</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-lg bg-white border flex items-center justify-center shadow-sm"><i class="fa-solid fa-chevron-left text-xs text-slate-400"></i></button>
                    <button onclick="changeMonth(1)" class="w-8 h-8 rounded-lg bg-white border flex items-center justify-center shadow-sm"><i class="fa-solid fa-chevron-right text-xs text-slate-400"></i></button>
                </div>
            </div>
            
            <div class="calendar-grid">
                <div class="day-header">Sun</div><div class="day-header">Mon</div><div class="day-header">Tue</div><div class="day-header">Wed</div><div class="day-header">Thu</div><div class="day-header">Fri</div><div class="day-header">Sat</div>
            </div>
            <div class="calendar-grid" id="calendar"></div>
        </div>

        <div class="bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-100">
            <h3 class="font-black text-slate-800 uppercase text-xs mb-4">ðŸ“‹ Lineup Registry</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead><tr class="text-[10px] text-slate-400 uppercase"><th>Ref No.</th><th>Lead Name</th><th>Status</th><th class="text-right">Action</th></tr></thead>
                    <tbody id="registry-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="form-modal">
        <div class="modal-content">
            <button type="button" onclick="closeModal()" class="absolute top-4 right-4 text-slate-300 hover:text-rose-500"><i class="fa-solid fa-circle-xmark text-2xl"></i></button>
            <div class="stepper">
                <div class="step-circle active" id="dot-1">1</div><div class="step-line"></div>
                <div class="step-circle" id="dot-2">2</div><div class="step-line"></div>
                <div class="step-circle" id="dot-3">3</div><div class="step-line"></div>
                <div class="step-circle" id="dot-4">4</div>
            </div>
            <form id="lineup-form" onsubmit="handleLineupSubmit(event)">
                <div class="form-step active" id="step-1">
                    <h2 class="text-sm font-black text-slate-800 uppercase mb-4">Step 1: Basic Info</h2>
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Ref No.</label>
                    <input type="text" id="ref-no" class="input-style bg-slate-100" readonly>
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">P&W Lead</label>
                    <input type="text" id="lead-name" class="input-style" placeholder="Enter Full Name" required>
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Selected Date</label>
                    <input type="text" id="form-date" class="input-style bg-slate-100" readonly>
                    <div class="flex justify-end"><button type="button" onclick="nextStep(2)" class="btn-nav bg-slate-800 text-white">Next</button></div>
                </div>
                <div class="form-step" id="step-2">
                    <h2 class="text-sm font-black text-slate-800 uppercase mb-4">Step 2: Start Songs</h2>
                    <input type="text" id="opening" class="input-style" placeholder="Opening Song Title">
                    <input type="text" id="welcome" class="input-style" placeholder="Welcome Song Title">
                    <div class="flex justify-between"><button type="button" onclick="nextStep(1)" class="btn-nav bg-slate-100">Back</button><button type="button" onclick="nextStep(3)" class="btn-nav bg-slate-800 text-white">Next</button></div>
                </div>
                <div class="form-step" id="step-3">
                    <h2 class="text-sm font-black text-slate-800 uppercase mb-4">Step 3: P&W Set</h2>
                    <div id="praise-container"></div>
                    <button type="button" onclick="addRow('praise-container', 'Praise')" class="text-[10px] font-black text-emerald-500 mb-4">+ Add Praise Song</button>
                    <div id="worship-container"></div>
                    <button type="button" onclick="addRow('worship-container', 'Worship')" class="text-[10px] font-black text-emerald-500 mb-4">+ Add Worship Song</button>
                    <div class="flex justify-between"><button type="button" onclick="nextStep(2)" class="btn-nav bg-slate-100">Back</button><button type="button" onclick="nextStep(4)" class="btn-nav bg-slate-800 text-white">Next</button></div>
                </div>
                <div class="form-step" id="step-4">
                    <h2 class="text-sm font-black text-slate-800 uppercase mb-4">Step 4: Closing & Notes</h2>
                    <input type="text" id="closing" class="input-style" placeholder="Closing Song Title">
                    <textarea id="admin-notes" class="input-style h-24 resize-none" placeholder="Notes for Music Admin (Optional)"></textarea>
                    <div class="flex justify-between"><button type="button" onclick="nextStep(3)" class="btn-nav bg-slate-100">Back</button><button type="submit" id="submit-btn" class="btn-nav bg-emerald-600 text-white">Submit Lineup</button></div>
                </div>
            </form>
        </div>
    </div>

    <div class="footer-container">
        <footer class="fixed-footer px-8">
            <div class="max-w-7xl mx-auto w-full flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="mcb.png" class="w-8 h-8" onerror="this.src='https://via.placeholder.com/32'">
                    <div><h4 class="font-black text-slate-800 text-[10px] uppercase leading-none">MCB Balilihan</h4><p class="text-[8px] font-bold text-slate-400 uppercase mt-1">Â© 2026 Official Portal</p></div>
                </div>
                <div class="text-right"><p class="text-[9px] font-black text-slate-300 uppercase leading-none">Developed By</p><p class="text-[11px] font-extrabold text-[#2D4E53] uppercase mt-1">Mark Brian D. Angco ðŸ«¶</p></div>
            </div>
        </footer>
        <div class="bottom-menu">
            <a href="index.html" class="menu-item"><i class="fa-solid fa-house"></i><span>Home</span></a>
            <a href="#" class="menu-item music-active"><i class="fa-solid fa-music"></i><span>Music</span></a>
        </div>
    </div>

    <script>
        const sb = supabase.createClient('https://eejovtuputrwneovhfpc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlam92dHVwdXRyd25lb3ZoZnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjY5MzIsImV4cCI6MjA4NjgwMjkzMn0.JJz64gSTT9qSqOkiJvuL1PT_H_I4ZYJbchrmkoljwws');

        let currentViewDate = new Date();

        function updateClock() {
            const now = new Date();
            document.getElementById('liveClock').innerText = now.toLocaleTimeString('en-GB');
            document.getElementById('liveDate').innerText = now.toDateString().toUpperCase();
            const hr = now.getHours();
            document.getElementById('greeting').innerText = hr < 12 ? "Maayong Buntag! â˜€ï¸" : hr < 18 ? "Maayong Hapon! ðŸŒ¤ï¸" : "Maayong Gabii! ðŸŒ™";
        }
        setInterval(updateClock, 1000);

        function changeMonth(offset) {
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            initCalendar();
        }

        function initCalendar() {
            const cal = document.getElementById('calendar');
            cal.innerHTML = '';
            const month = currentViewDate.getMonth();
            const year = currentViewDate.getFullYear();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('month-title').innerText = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'day empty';
                cal.appendChild(empty);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dayDiv = document.createElement('div');
                const isToday = today.getDate() === d && today.getMonth() === month && today.getFullYear() === year;
                dayDiv.className = isToday ? 'day today' : 'day';
                dayDiv.innerHTML = `<span>${d}</span>`;
                dayDiv.onclick = () => openModal(year, month, d);
                cal.appendChild(dayDiv);
            }
        }

        function openModal(y, m, d) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            document.getElementById('lineup-form').reset();
            document.getElementById('praise-container').innerHTML = '';
            document.getElementById('worship-container').innerHTML = '';
            document.getElementById('ref-no').value = "MCB-MUS-" + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('form-date').value = dateStr;
            nextStep(1);
            document.getElementById('form-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('form-modal').style.display = 'none'; }

        function nextStep(step) {
            document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
            document.getElementById('step-' + step).classList.add('active');
            document.querySelectorAll('.step-circle').forEach((dot, idx) => {
                if(idx + 1 <= step) dot.classList.add('active');
                else dot.classList.remove('active');
            });
        }

        function addRow(containerId, category) {
            const div = document.createElement('div');
            div.className = "flex gap-2 mb-2 dynamic-song-row";
            div.innerHTML = `<input type="text" class="input-style !mb-0 text-xs song-input" data-category="${category}" placeholder="${category} Song Title" required>
                             <button type="button" onclick="this.parentElement.remove()" class="text-rose-500 font-bold px-2">-</button>`;
            document.getElementById(containerId).appendChild(div);
        }

        async function handleLineupSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerText;
            btn.innerText = "Submitting...";
            btn.disabled = true;

            const songs = [];
            const refNo = document.getElementById('ref-no').value;
            const adminNotes = document.getElementById('admin-notes').value;
            songs.push({ category: "METADATA", ref: refNo, notes: adminNotes });

            const opening = document.getElementById('opening').value;
            const welcome = document.getElementById('welcome').value;
            if(opening) songs.push({ category: "Opening", song: opening });
            if(welcome) songs.push({ category: "Welcome", song: welcome });
            
            document.querySelectorAll('.song-input').forEach(input => {
                if(input.value.trim() !== "") {
                    songs.push({ category: input.getAttribute('data-category'), song: input.value.trim() });
                }
            });

            const closing = document.getElementById('closing').value;
            if(closing) songs.push({ category: "Closing", song: closing });

            const payload = {
                title: "Music",
                user_id: document.getElementById('lead-name').value,
                program_date: document.getElementById('form-date').value,
                content: JSON.stringify(songs),
                status: 'pending'
            };

            const { error } = await sb.from('programs').insert([payload]);

            if (error) {
                alert("Error: " + error.message);
                btn.innerText = originalText;
                btn.disabled = false;
            } else {
                alert("Lineup Submitted Successfully!");
                closeModal();
                loadData();
            }
        }

        // Fixed Function: Added useCORS and allowTaint
        async function generateSlip(itemId) {
            const { data, error } = await sb.from('programs').select('*').eq('id', itemId).single();
            if(error || !data) return alert("Error loading data");

            const content = JSON.parse(data.content);
            const metadata = content.find(c => c.category === "METADATA");
            const slipContent = document.getElementById('slip-content');
            
            let html = `
                <div class="grid grid-cols-2 gap-2 text-[10px] font-bold mb-4">
                    <div class="text-slate-400 uppercase">Ref No:</div><div class="text-slate-900">${metadata ? metadata.ref : 'N/A'}</div>
                    <div class="text-slate-400 uppercase">P&W Lead:</div><div class="text-slate-900 uppercase">${data.user_id}</div>
                    <div class="text-slate-400 uppercase">Date:</div><div class="text-slate-900">${data.program_date}</div>
                </div>
                <div class="space-y-2">
                    <h3 class="text-[9px] font-black text-slate-800 uppercase border-b pb-1">Song Lineup</h3>
            `;

            content.forEach(item => {
                if(item.category !== "METADATA") {
                    html += `
                        <div class="flex justify-between text-[10px]">
                            <span class="text-slate-400 font-bold uppercase">${item.category}:</span>
                            <span class="text-slate-800 font-extrabold uppercase">${item.song}</span>
                        </div>
                    `;
                }
            });

            html += `</div>`;
            slipContent.innerHTML = html;

            const template = document.getElementById('slip-template');
            
            // Fix: Added configuration for CORS and Taint
            html2canvas(template, { 
                scale: 2,
                useCORS: true, 
                allowTaint: true,
                backgroundColor: "#ffffff"
            }).then(canvas => {
                try {
                    const link = document.createElement('a');
                    link.download = `MCB-SLIP-${data.user_id}-${data.program_date}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                } catch (err) {
                    console.error("Canvas export failed:", err);
                    alert("Export failed due to image security. Please try again or use a local image source.");
                }
            });
        }

        async function loadData() {
            const { data } = await sb.from('programs').select('*').eq('title', 'Music').order('created_at', {ascending: false});
            const body = document.getElementById('registry-body');
            body.innerHTML = '';
            if (data) {
                data.forEach(item => {
                    let displayRef = "REF-PENDING";
                    try {
                        const contentObj = JSON.parse(item.content);
                        const metadata = contentObj.find(c => c.category === "METADATA");
                        if(metadata && metadata.ref) displayRef = metadata.ref;
                    } catch(e) { console.error("JSON Parse Error"); }
                    
                    const isApproved = item.status === 'approved';
                    const statusColor = isApproved ? 'bg-emerald-100 text-emerald-600' : 
                                      item.status === 'rejected' ? 'bg-rose-100 text-rose-600' : 'bg-amber-100 text-amber-600';

                    body.innerHTML += `
                        <tr class="border-b border-slate-50 text-xs font-semibold">
                            <td class="py-4 text-[#2D4E53] font-bold">${displayRef}</td>
                            <td class="uppercase text-slate-700">${item.user_id}</td>
                            <td><span class="px-2 py-0.5 rounded-full text-[8px] font-black uppercase ${statusColor}">${item.status}</span></td>
                            <td class="text-right space-x-2">
                                ${isApproved ? `<button onclick="generateSlip('${item.id}')" class="text-emerald-500 text-xs hover:text-emerald-700"><i class="fa-solid fa-file-arrow-down"></i> DL</button>` : ''}
                                <button class="text-slate-400 text-xs hover:text-emerald-500"><i class="fa-solid fa-eye"></i></button>
                            </td>
                        </tr>`;
                });
            }
        }

        window.onload = () => { updateClock(); initCalendar(); loadData(); };
    </script>
</body>
</html>
